services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver-test
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${SA_PASSWORD:-P@ssw0rd123!}
      MSSQL_PID: ${MSSQL_PID:-Express}
    ports:
      - "127.0.0.1:1433:1433"
    volumes:
      - ./data/mssql:/var/opt/mssql
      - ./backups:/var/opt/mssql/backup
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${SA_PASSWORD:-P@ssw0rd123!}" -C -Q "SELECT 1" -b
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: cloudbeaver
    restart: unless-stopped
    ports:
      - "127.0.0.1:8978:8978"
    volumes:
      - cloudbeaver_workspace:/opt/cloudbeaver/workspace
      - ./cloudbeaver-config/data-sources.json:/opt/cloudbeaver/conf/initial-data-sources.conf:ro
      - ./cloudbeaver-config/data-sources-permissions.json:/opt/cloudbeaver/conf/initial-data-sources-permissions.conf:ro
    environment:
      CB_SERVER_NAME: ${CB_SERVER_NAME:-SQL Server Test}
      CB_ADMIN_NAME: ${CB_ADMIN_NAME:-cbadmin}
      CB_ADMIN_PASSWORD: ${CB_ADMIN_PASSWORD:-P@ssw0rd123!}
      CLOUDBEAVER_APP_GRANT_CONNECTIONS_ACCESS_TO_ANONYMOUS_TEAM: "true"
    depends_on:
      - mssql

volumes:
  cloudbeaver_workspace:
